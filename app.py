# -------------------------
# åŒ¯å…¥éœ€è¦çš„å¥—ä»¶
# -------------------------
import streamlit as st              # Streamlit:ç”¨ä¾†åšç¶²é ä»‹é¢
import pandas as pd                 # pandas:è®€å–èˆ‡è™•ç† Excel è³‡æ–™
import random                       # random:éš¨æ©Ÿé¸è™Ÿã€å¹¸é‹å€¼
from collections import Counter     # Counter:çµ±è¨ˆå‡ºç¾æ¬¡æ•¸
from itertools import combinations  # combinations:è¨ˆç®—è™Ÿç¢¼å…±ç¾é—œä¿‚

# =====================================================
# æ¨¡å‹é è¨­åƒæ•¸(æ•´å€‹ App çš„åŸºæº–è¨­å®š)
# =====================================================

DEFAULT_FREQ_WEIGHT = 0.6     # æ­·å²å‡ºç¾é »ç‡å½±éŸ¿ç¨‹åº¦
DEFAULT_CO_WEIGHT = 0.2       # è™Ÿç¢¼å…±ç¾é—œä¿‚å½±éŸ¿ç¨‹åº¦
DEFAULT_NOISE = 0.3           # éš¨æ©Ÿæ“¾å‹•å¼·åº¦(ç„å­¸æˆåˆ†)

# éš¨æ©Ÿæ“¾å‹•å¯¦éš›ä½¿ç”¨çš„ç¯„åœ
DEFAULT_NOISE_RANGE = (1 - DEFAULT_NOISE, 1 + DEFAULT_NOISE)


# -------------------------
# è¨­å®šç¶²é åŸºæœ¬è³‡è¨Š
# -------------------------
st.set_page_config(
    page_title="æ¨‚é€æ™ºæ…§é¸è™Ÿå™¨",
    page_icon="ğŸ¯",
    layout="centered"
)

# =====================================================
# åˆå§‹åŒ– Session State(åªåœ¨ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚åŸ·è¡Œ)
# =====================================================

if "freq_w" not in st.session_state:
    st.session_state.freq_w = DEFAULT_FREQ_WEIGHT

if "co_w" not in st.session_state:
    st.session_state.co_w = DEFAULT_CO_WEIGHT

if "noise" not in st.session_state:
    st.session_state.noise = DEFAULT_NOISE

# -------------------------
# ç¶²é æ¨™é¡Œèˆ‡èªªæ˜
# -------------------------
st.title("ğŸ¯ æ¨‚é€æ™ºæ…§é¸è™Ÿå™¨")
st.caption("çµ±è¨ˆç†å·¥ Ã— å¤©é¸ä¹‹äººï½œç†æ€§èˆ‡å‘½é‹çš„äº¤æœƒ ğŸ¤")

# =====================================================
# Step 1:é¸æ“‡æ¨‚é€ç¨®é¡
# =====================================================
game_type = st.radio(
    "ğŸ® é¸æ“‡æ¨‚é€ç©æ³•",
    ["å¤§æ¨‚é€", "å¨åŠ›å½©"],
    horizontal=True
)

# =====================================================
# Step 2:é¸æ“‡é¸è™Ÿæ¨¡å¼
# =====================================================
mode = st.radio(
    "ğŸ›ï¸ é¸è™Ÿæ¨¡å¼",
    ["çµ±è¨ˆç†å·¥æ¨¡å¼ ğŸ§ ", "å¤©é¸ä¹‹äººæ¨¡å¼ ğŸ”®"]
)

# =====================================================
# Step 3:ä¾ç©æ³•è®€å–å°æ‡‰è³‡æ–™
# =====================================================
try:
    if game_type == "å¤§æ¨‚é€":
        # è®€å–å¤§æ¨‚é€æ­·å²è³‡æ–™
        df = pd.read_excel("lotto_big.xlsx")
        
        # å…­å€‹ä¸»è™Ÿæ¬„ä½åç¨±
        number_cols = ["çè™Ÿ1", "çè™Ÿ2", "çè™Ÿ3", "çè™Ÿ4", "çè™Ÿ5", "çè™Ÿ6"]
        
        # ä¸»è™Ÿç¯„åœ 1~49
        number_range = range(1, 50)
        
        # å¤§æ¨‚é€æ²’æœ‰ç¬¬äºŒå€
        special_range = None
    
    else:
        # è®€å–å¨åŠ›å½©æ­·å²è³‡æ–™
        df = pd.read_excel("lotto_power.xlsx")
        
        # å…­å€‹ç¬¬ä¸€å€è™Ÿç¢¼æ¬„ä½
        number_cols = ["çè™Ÿ1", "çè™Ÿ2", "çè™Ÿ3", "çè™Ÿ4", "çè™Ÿ5", "çè™Ÿ6"]
        
        # ç¬¬ä¸€å€è™Ÿç¢¼ç¯„åœ 1~38
        number_range = range(1, 39)
        
        # ç¬¬äºŒå€è™Ÿç¢¼ç¯„åœ 1~8
        special_range = range(1, 9)
    
    # åªç•™ä¸‹å…­å€‹ä¸»è™Ÿ,æ–¹ä¾¿å¾ŒçºŒè¨ˆç®—
    numbers_df = df[number_cols]

except FileNotFoundError:
    st.error("âŒ æ‰¾ä¸åˆ°æ­·å²è³‡æ–™æª”æ¡ˆ,è«‹ç¢ºèª lotto_big.xlsx å’Œ lotto_power.xlsx æ˜¯å¦å­˜åœ¨")
    st.stop()
except Exception as e:
    st.error(f"âŒ è®€å–è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}")
    st.stop()

# =====================================================
# Step 4:çµ±è¨ˆæ­·å²å‡ºç¾é »ç‡(åªåœ¨ç†å·¥æ¨¡å¼ä½¿ç”¨)
# =====================================================
freq_counter = Counter(numbers_df.values.flatten())  # æ¯å€‹è™Ÿç¢¼å‡ºç¾æ¬¡æ•¸
max_freq = max(freq_counter.values()) if freq_counter else 1  # æœ€å¤§å‡ºç¾æ¬¡æ•¸(ç”¨ä¾†æ­£è¦åŒ–)

# =====================================================
# Step 5:è¨ˆç®—è™Ÿç¢¼å…±ç¾é—œä¿‚(å…©å…©ä¸€èµ·å‡ºç¾)
# =====================================================
pair_counter = Counter()

for row in numbers_df.values:
    # æ¯ä¸€æœŸçš„ 6 å€‹è™Ÿç¢¼,å–æ‰€æœ‰å…©å…©çµ„åˆ
    for a, b in combinations(sorted(row), 2):
        pair_counter[(a, b)] += 1

# å…±ç¾æ¬¡æ•¸æœ€å¤§å€¼(é¿å…é™¤ä»¥ 0)
max_pair = max(pair_counter.values()) if pair_counter else 1

# =====================================================
# Step 6:çµ±è¨ˆç†å·¥æ¨¡å¼ â†’ å»ºç«‹æ¬Šé‡
# =====================================================
def build_weights(freq_w, co_w, noise_range):
    """
    å»ºç«‹æ¯å€‹è™Ÿç¢¼çš„æ¬Šé‡(è¶Šå¤§è¶Šå®¹æ˜“è¢«æŠ½ä¸­)
    
    åƒæ•¸:
        freq_w: æ­·å²é »ç‡æ¬Šé‡ä¿‚æ•¸
        co_w: å…±ç¾é—œä¿‚æ¬Šé‡ä¿‚æ•¸
        noise_range: éš¨æ©Ÿæ“¾å‹•ç¯„åœ(æœ€å°å€¼, æœ€å¤§å€¼)
    
    å›å‚³:
        weights: å­—å…¸,keyæ˜¯è™Ÿç¢¼,valueæ˜¯è©²è™Ÿç¢¼çš„æ¬Šé‡
    """
    weights = {}
    
    for num in number_range:
        # æ­·å²é »ç‡æ¬Šé‡(æ­£è¦åŒ–åˆ° 0~1)
        freq_score = freq_counter.get(num, 0) / max_freq
        
        # èˆ‡å…¶ä»–è™Ÿç¢¼çš„å…±ç¾ç¨‹åº¦(æ­£è¦åŒ–åˆ° 0~1)
        co_score = sum(
            pair_counter.get((min(num, other), max(num, other)), 0)
            for other in number_range if other != num  # æ’é™¤è‡ªå·±
        ) / max_pair
        
        # éš¨æ©Ÿæ“¾å‹•(ç„å­¸ä¾†æº)
        noise = random.uniform(*noise_range)
        
        # æœ€çµ‚æ¬Šé‡ = (é »ç‡åˆ†æ•¸ Ã— é »ç‡ä¿‚æ•¸ + å…±ç¾åˆ†æ•¸ Ã— å…±ç¾ä¿‚æ•¸) Ã— éš¨æ©Ÿæ“¾å‹•
        raw_weight = (freq_w * freq_score + co_w * co_score)
        weights[num] = max(raw_weight * noise, 1e-6)  # ç¢ºä¿æœ€å°å€¼ä¸ç‚º0
    
    return weights

# =====================================================
# Step 7:ä¾æ¬Šé‡ç”¢ç”Ÿ 6 å€‹ä¸é‡è¤‡è™Ÿç¢¼(çµ±è¨ˆç†å·¥æ¨¡å¼)
# =====================================================
def generate_weighted_numbers(weights):
    """
    æ ¹æ“šæ¬Šé‡æŠ½å‡º6å€‹ä¸é‡è¤‡çš„è™Ÿç¢¼
    
    åƒæ•¸:
        weights: æ¯å€‹è™Ÿç¢¼çš„æ¬Šé‡å­—å…¸
    
    å›å‚³:
        selected: æ’åºå¾Œçš„6å€‹è™Ÿç¢¼æ¸…å–®
    """
    available = list(weights.keys())  # æ‰€æœ‰å¯é¸è™Ÿç¢¼
    selected = []  # å·²é¸ä¸­çš„è™Ÿç¢¼
    
    total_weight = sum(weights.values())
    if total_weight <= 0:
        # æ¥µç«¯æƒ…æ³é€€å›ç´”éš¨æ©Ÿ
        return sorted(random.sample(available, 6))
    
    # ä¾åºæŠ½å‡º6å€‹è™Ÿç¢¼,æ¯æŠ½ä¸€å€‹å°±å¾å€™é¸æ± ä¸­ç§»é™¤
    for _ in range(6):
        chosen = random.choices(
            available,
            weights=[weights[n] for n in available],  # åªè¨ˆç®—å‰©é¤˜è™Ÿç¢¼çš„æ¬Šé‡
            k=1
        )[0]
        
        selected.append(chosen)
        available.remove(chosen)  # ç§»é™¤å·²é¸è™Ÿç¢¼,ç¢ºä¿ä¸é‡è¤‡
    
    return sorted(selected)  # å›å‚³æ’åºå¾Œçš„è™Ÿç¢¼

# =====================================================
# Step 8:å®Œå…¨éš¨æ©Ÿé¸è™Ÿ(å¤©é¸ä¹‹äººæ¨¡å¼) - ğŸ”´ æ–°å¢å‡½æ•¸ä¿®æ­£éŒ¯èª¤
# =====================================================
def generate_random_numbers():
    """
    å®Œå…¨éš¨æ©Ÿé¸å‡º6å€‹ä¸é‡è¤‡è™Ÿç¢¼(ä¸è€ƒæ…®æ­·å²è³‡æ–™)
    
    å›å‚³:
        æ’åºå¾Œçš„6å€‹è™Ÿç¢¼æ¸…å–®
    """
    return sorted(random.sample(list(number_range), 6))

# =====================================================
# Step 9:ä»Šæ—¥å¹¸é‹å€¼è¨ˆç®— - ğŸ’¡ æ”¹é€²ç‰ˆ(æ›´æ¨‚è§€çš„åˆ†æ•¸)
# =====================================================
def luck_score(selected, weights=None):
    """
    å¹¸é‹å€¼è¨ˆç®— - æ”¹é€²ç‰ˆ,åˆ†æ•¸æœƒæ›´å¹³è¡¡
    
    åƒæ•¸:
        selected: é¸ä¸­çš„è™Ÿç¢¼æ¸…å–®
        weights: è™Ÿç¢¼æ¬Šé‡(å¤©é¸æ¨¡å¼ç‚ºNone)
    
    å›å‚³:
        1-99ä¹‹é–“çš„æ•´æ•¸å¹¸é‹å€¼
    """
    if weights is None:
        # å¤©é¸æ¨¡å¼:çµ¦äºˆåé«˜çš„éš¨æ©Ÿåˆ†æ•¸(60-95ä¹‹é–“,ç¬¦åˆã€Œå¤©é¸ã€æ„Ÿè¦º)
        return random.randint(60, 95)
    
    # çµ±è¨ˆæ¨¡å¼:è¨ˆç®—è™Ÿç¢¼çš„å¹³å‡æ¬Šé‡ç™¾åˆ†ä½
    all_weights = sorted(weights.values(), reverse=True)
    
    # è¨ˆç®—é¸ä¸­è™Ÿç¢¼çš„å¹³å‡æ¬Šé‡æ’å
    percentiles = []
    for num in selected:
        weight = weights[num]
        # è¨ˆç®—æ­¤è™Ÿç¢¼çš„æ¬Šé‡åœ¨æ‰€æœ‰è™Ÿç¢¼ä¸­çš„ç™¾åˆ†ä½(è¶Šé«˜è¶Šå¥½)
        rank = sum(1 for w in all_weights if w > weight)
        percentile = (1 - rank / len(all_weights)) * 100
        percentiles.append(percentile)
    
    # å¹³å‡ç™¾åˆ†ä½ä½œç‚ºåŸºæº–åˆ†æ•¸
    base_score = sum(percentiles) / len(percentiles)
    
    # åŠ å…¥æ­£å‘éš¨æ©Ÿæ³¢å‹•(-5åˆ°+15,è®“åˆ†æ•¸æ›´æ¨‚è§€)
    score = base_score + random.uniform(-5, 15)
    
    # ç¢ºä¿åˆ†æ•¸åœ¨åˆç†ç¯„åœå…§(30-99)
    return int(max(30, min(score, 99)))

# =====================================================
# Step 10:çµ±è¨ˆç†å·¥æ¨¡å¼ â†’ åƒæ•¸æ»‘æ¡¿(å«å°èªªæ˜)
# =====================================================
if mode == "çµ±è¨ˆç†å·¥æ¨¡å¼ ğŸ§ ":
    st.markdown("### âš™ï¸ æ¨¡å‹åƒæ•¸è¨­å®š")
    
    freq_w = st.slider(
        "ğŸ“Š æ­·å²é »ç‡æ¬Šé‡",
        0.0, 1.0,
        step=0.05,
        key="freq_w",
        help=(
            "ğŸ“ˆ æ§åˆ¶ã€æ­·å²å¸¸å‡ºç¾è™Ÿç¢¼ã€çš„å½±éŸ¿åŠ›ã€‚\n\n"
            "æ•¸å€¼è¶Šé«˜,è¶Šåå¥½éå»å‡ºç¾æ¬¡æ•¸å¤šçš„è™Ÿç¢¼;\n"
            "æ•¸å€¼è¶Šä½,æ­·å²è³‡æ–™å½±éŸ¿è¶Šå°ã€‚"
        )
    )
    
    co_w = st.slider(
        "ğŸ”— è™Ÿç¢¼é…å°æ¬Šé‡",
        0.0, 1.0,
        step=0.05,
        key="co_w",
        help=(
            "ğŸ”— æ§åˆ¶ã€è™Ÿç¢¼å½¼æ­¤ä¸€èµ·å‡ºç¾ã€çš„å½±éŸ¿åŠ›ã€‚\n\n"
            "é€™æ˜¯çµ±è¨ˆå­¸ä¸­çš„ã€Œå…±ç¾åˆ†æã€,åˆ†æå“ªäº›è™Ÿç¢¼åœ¨æ­·å²ä¸Šå¸¸ä¸€èµ·é–‹å‡ºã€‚\n"
            "æ•¸å€¼è¶Šé«˜,è¶Šåå¥½æ­·å²ä¸Šå¸¸ä¸€èµ·å‡ºç¾çš„è™Ÿç¢¼çµ„åˆ;\n"
            "æ•¸å€¼è¶Šä½,çµ„åˆé—œä¿‚å½±éŸ¿è¶Šå°ã€‚"
        )
    )
    
    noise = st.slider(
        "ğŸ² éš¨æ©Ÿæ“¾å‹•å¼·åº¦",
        0.0, 1.0,
        step=0.05,
        key="noise",
        help=(
            "ğŸ² æ§åˆ¶ã€éš¨æ©Ÿæ€§/è®ŠåŒ–åº¦ã€çš„å¼·åº¦ã€‚\n\n"
            "æ•¸å€¼è¶Šé«˜,æ¯æ¬¡çµæœè®ŠåŒ–è¶Šå¤§;\n"
            "æ•¸å€¼è¶Šä½,é¸è™Ÿçµæœè¶Šç©©å®šã€‚"
        )
    )

# =====================================================
# Step 11:æŒ‰éˆ• â†’ ç”¢ç”Ÿå»ºè­°è™Ÿç¢¼(ä¿®æ­£ç‰ˆ)
# =====================================================
if st.button("ğŸ° ç”¢ç”Ÿå»ºè­°è™Ÿç¢¼", type="primary"):
    
    # æ ¹æ“šæ¨¡å¼é¸æ“‡å°æ‡‰çš„é¸è™Ÿæ–¹å¼
    if mode == "çµ±è¨ˆç†å·¥æ¨¡å¼ ğŸ§ ":
        # çµ±è¨ˆæ¨¡å¼:å»ºç«‹æ¬Šé‡å¾Œä¾æ¬Šé‡é¸è™Ÿ
        weights = build_weights(
            st.session_state.freq_w,
            st.session_state.co_w,
            (
                1 - st.session_state.noise,
                1 + st.session_state.noise
            )
        )
        main_nums = generate_weighted_numbers(weights)
        luck = luck_score(main_nums, weights)
    
    else:
        # å¤©é¸æ¨¡å¼:å®Œå…¨éš¨æ©Ÿé¸è™Ÿ
        main_nums = generate_random_numbers()
        luck = luck_score(main_nums)  # weights=None
    
    # æ ¼å¼åŒ–è™Ÿç¢¼é¡¯ç¤º(è£œé›¶åˆ°å…©ä½æ•¸,ç”¨é “è™Ÿåˆ†éš”)
    formatted = "ã€".join(f"{n:02d}" for n in main_nums)
    
    st.subheader("ğŸ¯ å»ºè­°è™Ÿç¢¼")
    
    # é¡¯ç¤ºç¬¬ä¸€å€è™Ÿç¢¼
    if game_type == "å¨åŠ›å½©":
        st.success(f"ç¬¬ä¸€å€: {formatted}")
    else:
        st.success(formatted)
    
    # å¨åŠ›å½©éœ€è¦é¡å¤–é¡¯ç¤ºç¬¬äºŒå€è™Ÿç¢¼
    if game_type == "å¨åŠ›å½©":
        special = random.choice(list(special_range))  # ç¬¬äºŒå€éš¨æ©Ÿé¸1å€‹
        st.info(f"ç¬¬äºŒå€: {special:02d}")
    
    # é¡¯ç¤ºå¹¸é‹å€¼
    st.markdown(f"### ğŸ€ ä»Šæ—¥å¹¸é‹å€¼: **{luck}%**")
    
    # æ ¹æ“šå¹¸é‹å€¼çµ¦äºˆä¸åŒçš„é¼“å‹µè¨Šæ¯
    if luck >= 80:
        st.success("âœ¨ å¹¸é‹çˆ†æ£š!ä»Šå¤©å°±æ˜¯ä½ çš„å¤§æ—¥å­!")
    elif luck >= 60:
        st.info("ğŸ˜Š é‹å‹¢ä¸éŒ¯!å€¼å¾—ä¸€è©¦!")
    else:
        st.warning("ğŸ¤ å¹³ç©©é‹å‹¢,ä½†èª°çŸ¥é“å‘¢?")
    
    st.markdown("---")
    st.markdown("### ğŸ‰ ç¥æ‚¨ä¸­å¤§ç!!")

# =====================================================
# é é¢åº•éƒ¨èªªæ˜
# =====================================================
st.markdown("---")
with st.expander("â„¹ï¸ ä½¿ç”¨èªªæ˜"):
    st.markdown("""
    ### çµ±è¨ˆç†å·¥æ¨¡å¼ ğŸ§ 
    - æ ¹æ“šæ­·å²é–‹çè¨˜éŒ„,åˆ†æè™Ÿç¢¼å‡ºç¾é »ç‡å’Œé…å°é—œä¿‚
    - å¯èª¿æ•´åƒæ•¸ä¾†æ”¹è®Šé¸è™Ÿç­–ç•¥
    - é©åˆå–œæ­¡æ•¸æ“šåˆ†æçš„ç©å®¶
    
    ### å¤©é¸ä¹‹äººæ¨¡å¼ ğŸ”®
    - å®Œå…¨éš¨æ©Ÿé¸è™Ÿ,ä¸å—æ­·å²å½±éŸ¿
    - æ¯å€‹è™Ÿç¢¼æ©Ÿç‡å®Œå…¨ç›¸åŒ
    - é©åˆç›¸ä¿¡å‘½é‹å’Œç›´è¦ºçš„ç©å®¶
    
    ### é—œæ–¼å¹¸é‹å€¼
    - å¹¸é‹å€¼åƒ…ä¾›å¨›æ¨‚åƒè€ƒ
    - çµ±è¨ˆæ¨¡å¼:åæ˜ è™Ÿç¢¼ç¬¦åˆæ¨¡å‹åå¥½çš„ç¨‹åº¦
    - å¤©é¸æ¨¡å¼:ç´”ç²¹çš„å¹¸é‹åŠ æŒ
    - **æ³¨æ„:å¹¸é‹å€¼ä¸ç­‰æ–¼ä¸­çæ©Ÿç‡!**
    
    ### æº«é¦¨æé†’
    å½©åˆ¸æ˜¯å¨›æ¨‚æ€§è³ª,è«‹ç†æ€§è³¼è²·,é‡åŠ›è€Œç‚º ğŸ’
    """)
